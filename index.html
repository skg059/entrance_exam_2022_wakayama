<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>デジタル教科書ビューアー</title>
<link rel="icon" href="/favicon.ico">

<style>
body{
  margin:0;
  background:white;
  height:100vh;
  overflow:hidden;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
}

.viewer{
  position:relative;
  width:100%;
  height:100%;
  overflow:hidden;
  touch-action:none;
}

img{
  position:absolute;
  top:50%;
  left:50%;
  max-width:100vw;
  max-height:100vh;
  transform:translate(-50%,-50%) scale(1);
  transform-origin:center center;
  z-index:1;
}

.left,.right{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  width:54px;
  height:54px;
  border-radius:50%;
  background:#e0e0e0;
  border:none;
  font-size:22px;
  color:#333;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
  z-index:1000;
}
.left{ left:20px; }
.right{ right:20px; }

.reset-button{
  position:absolute;
  bottom:0;
  left:50%;
  transform:translateX(-50%);
  width:150px;
  height:46px;
  border-radius:12px 12px 0 0;
  border:none;
  background:#f2f2f2;
  color:#333;
  display:none;
  z-index:1000;
}

.page-number{
  position:absolute;
  bottom:70px;
  left:50%;
  transform:translateX(-50%);
  background:#f5f5f5;
  padding:6px 14px;
  border-radius:20px;
  font-size:13px;
  display:none;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  z-index:1000;
}

.audio-toggle{
  position:absolute;
  top:15px;
  left:15px;
  background:#f0f0f0;
  border:none;
  padding:8px 14px;
  border-radius:20px;
  font-size:13px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  z-index:1000;
}

.audio-bar{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  background:#fafafa;
  border-bottom:1px solid #ddd;
  padding:10px;
  display:none;
  z-index:2000;
  box-sizing:border-box;
}

.audio-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}

.audio-title{
  font-size:13px;
  font-weight:500;
  color:#333;
}

.close-audio{
  border:none;
  background:none;
  font-size:16px;
}

.audio-controls{
  display:flex;
  align-items:center;
  gap:6px;
}

.audio-controls button{
  border:none;
  background:#e5e5e5;
  padding:5px 8px;
  border-radius:6px;
  font-size:12px;
}

.audio-controls input{
  flex:1;
}

.time-display{
  width:45px;
  font-size:12px;
  text-align:right;
}
</style>
</head>

<body>

<div class="viewer">

<button class="audio-toggle" onclick="toggleAudioBar()">音声</button>

<div class="audio-bar" id="audioBar">
  <div class="audio-header">
    <div class="audio-title">英_22_公_和歌山_L_01.mp3</div>
    <button class="close-audio" onclick="closeAudioBar()">✕</button>
  </div>

  <div class="audio-controls">
    <button onclick="playAudio()">再生</button>
    <button onclick="pauseAudio()">停止</button>
    <button onclick="restartAudio()">最初</button>
    <input type="range" id="seekBar" value="0">
    <span class="time-display" id="timeDisplay">0:00</span>
  </div>
</div>

<button class="left" onclick="prevPage()">◀</button>
<button class="right" onclick="nextPage()">▶</button>

<img id="pageImage" src="pages/1.png">

<div class="page-number" id="pageNumber">1 / 6</div>
<button class="reset-button" id="resetButton" onclick="resetZoom()">もどる</button>

</div>

<audio id="audioPlayer" src="audio/sample.mp3"></audio>

<script>
let currentPage = 1;
const totalPages = 11;

let scale = 1;
let startScale = 1;
let initialDistance = null;

let translateX = -50;
let translateY = -50;
let startX = 0;
let startY = 0;
let swipeStartX = 0;

const image = document.getElementById("pageImage");
const pageNumber = document.getElementById("pageNumber");
const resetButton = document.getElementById("resetButton");

/* ===== 画像プリロード ===== */
const imageCache = [];
for(let i=1;i<=totalPages;i++){
  const img = new Image();
  img.src = `pages/${i}.png`;
  imageCache.push(img);
}

/* ===== 拡大・移動 ===== */
function getDistance(t){
  const dx = t[0].clientX - t[1].clientX;
  const dy = t[0].clientY - t[1].clientY;
  return Math.sqrt(dx*dx + dy*dy);
}

function updateTransform(){
  image.style.transform =
    `translate(${translateX}%, ${translateY}%) scale(${scale})`;
}

function updateResetButton(){
  resetButton.style.display = scale > 1 ? "block" : "none";
}

function resetZoom(){
  scale = 1;
  translateX = -50;
  translateY = -50;
  updateTransform();
  updateResetButton();
}

image.addEventListener("touchstart", e=>{
  if(e.touches.length === 2){
    initialDistance = getDistance(e.touches);
    startScale = scale;
  }else if(e.touches.length === 1){
    swipeStartX = e.touches[0].clientX;
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  }
});

image.addEventListener("touchmove", e=>{
  if(e.touches.length === 2){
    const zoom = getDistance(e.touches) / initialDistance;
    scale = Math.min(Math.max(1, startScale * zoom), 4);
    updateTransform();
    updateResetButton();
  }

  if(e.touches.length === 1 && scale > 1){
    const dx = e.touches[0].clientX - startX;
    const dy = e.touches[0].clientY - startY;

    const speed = 1.3; // ★ 減速ポイント
    translateX += dx / window.innerWidth * 100 * speed;
    translateY += dy / window.innerHeight * 100 * speed;

    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;

    updateTransform();
  }
});

image.addEventListener("touchend", e=>{
  if(scale > 1) return;

  const diff = e.changedTouches[0].clientX - swipeStartX;
  if(Math.abs(diff) > 60){
    diff < 0 ? nextPage() : prevPage();
  }
});

/* ===== ページ ===== */
function showPageNumber(){
  pageNumber.style.display = "block";
  setTimeout(()=>pageNumber.style.display="none",3000);
}

function updatePage(){
  image.src = imageCache[currentPage-1].src;
  pageNumber.textContent = currentPage + " / " + totalPages;
  resetZoom();
  showPageNumber();
}

function prevPage(){ if(currentPage > 1){ currentPage--; updatePage(); } }
function nextPage(){ if(currentPage < totalPages){ currentPage++; updatePage(); } }

/* ===== 音声 ===== */
const audioPlayer = document.getElementById("audioPlayer");
const seekBar = document.getElementById("seekBar");
const timeDisplay = document.getElementById("timeDisplay");
const audioBar = document.getElementById("audioBar");

function toggleAudioBar(){ audioBar.style.display="block"; }
function closeAudioBar(){ audioBar.style.display="none"; }

function playAudio(){ audioPlayer.play(); }
function pauseAudio(){ audioPlayer.pause(); }
function restartAudio(){ audioPlayer.currentTime = 0; audioPlayer.play(); }

audioPlayer.addEventListener("loadedmetadata",()=>{
  seekBar.max = audioPlayer.duration;
});

audioPlayer.addEventListener("timeupdate",()=>{
  seekBar.value = audioPlayer.currentTime;
  const m = Math.floor(audioPlayer.currentTime / 60);
  const s = Math.floor(audioPlayer.currentTime % 60).toString().padStart(2,"0");
  timeDisplay.textContent = `${m}:${s}`;
});

seekBar.addEventListener("input",()=>{
  audioPlayer.currentTime = seekBar.value;
});
</script>

</body>
</html>